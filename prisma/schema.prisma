generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  STUDENT
  FACULTY
  ADMIN
  SUPER_ADMIN
}

enum CourseType {
  B_TECH
  DIPLOMA
}

enum AcademicYear {
  YEAR_1
  YEAR_2
  YEAR_3
  YEAR_4
}

enum Semester {
  SEM_1
  SEM_2
  SEM_3
  SEM_4
  SEM_5
  SEM_6
  SEM_7
  SEM_8
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum ComplaintStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum FeeStatus {
  PENDING
  PAID
  OVERDUE
  WAIVED
}

enum NotificationType {
  ASSIGNMENT
  ATTENDANCE
  NOTICE
  COMPLAINT
  FEE
  GRADE
  GENERAL
}

enum InstitutionType {
  ENGINEERING
  POLYTECHNIC
  BOTH
}

model Institution {
  id              String    @id @default(cuid())
  name            String
  code            String    @unique
  college_code     String
  type            InstitutionType @default(ENGINEERING)
  address         String?
  phone           String?
  email           String?
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  users           User[]
  students        Student[]
  faculty         Faculty[]
  branches        Branch[]
  subjects        Subject[]
  fee_structures  FeeStructure[]
  notifications   Notification[]

  @@index([code])
  @@map("institutions")
}

model StudentPreImport {
  id              String    @id @default(cuid())
  institution_id  String
  pin_number      String
  first_name      String
  last_name       String?
  email           String?
  year            String
  semester        String
  course_code     String
  course_name     String
  is_registered   Boolean   @default(false)
  registered_at   DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@unique([institution_id, pin_number])
  @@index([pin_number])
  @@index([is_registered])
  @@map("student_pre_imports")
}

model Branch {
  id              String      @id @default(cuid())
  institution_id  String
  name            String
  code            String
  course_type     CourseType
  duration_years  Int         @default(4)
  is_active       Boolean     @default(true)
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  institution     Institution @relation(fields: [institution_id], references: [id])
  students        Student[]
  faculty         Faculty[]
  subjects        Subject[]

  @@unique([institution_id, code])
  @@index([institution_id])
  @@index([course_type])
  @@map("branches")
}

model Student {
  id              String    @id @default(cuid())
  user_id         String    @unique
  institution_id  String
  branch_id       String
  pin_number      String    @unique
  admission_year  Int
  roll_number     String?
  academic_year   AcademicYear @default(YEAR_1)
  current_semester Semester   @default(SEM_1)
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  user            User      @relation("UserStudent", fields: [user_id], references: [id], onDelete: Cascade)
  institution     Institution @relation(fields: [institution_id], references: [id])
  branch          Branch    @relation(fields: [branch_id], references: [id])
  enrollments     Enrollment[]
  fee_payments    FeePayment[]
  attendances     Attendance[] @relation("StudentAttendances")
  submissions     Submission[] @relation("StudentSubmissions")

  @@index([institution_id])
  @@index([branch_id])
  @@index([pin_number])
  @@index([admission_year])
  @@map("students")
}

model Faculty {
  id              String    @id @default(cuid())
  user_id         String    @unique
  institution_id  String
  branch_id       String?
  employee_id     String    @unique
  designation     String?
  specialization  String?
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  user            User      @relation("UserFaculty", fields: [user_id], references: [id], onDelete: Cascade)
  institution     Institution @relation(fields: [institution_id], references: [id])
  branch          Branch?   @relation(fields: [branch_id], references: [id])
  subjects        Subject[]
  enrollments     Enrollment[]

  @@index([institution_id])
  @@index([branch_id])
  @@map("faculty")
}

model Subject {
  id              String    @id @default(cuid())
  code            String
  name            String
  credits         Int       @default(3)
  institution_id  String
  branch_id       String?
  faculty_id      String?
  semester        Semester
  academic_year   String
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  institution     Institution @relation(fields: [institution_id], references: [id])
  branch          Branch?   @relation(fields: [branch_id], references: [id])
  faculty         Faculty?   @relation(fields: [faculty_id], references: [id])
  enrollments     Enrollment[]
  assignments     Assignment[]
  attendances     Attendance[]

  @@unique([institution_id, code])
  @@index([institution_id])
  @@index([branch_id])
  @@index([faculty_id])
  @@index([semester])
  @@map("subjects")
}

model Enrollment {
  id              String    @id @default(cuid())
  student_id      String
  subject_id      String
  faculty_id      String
  enrollment_date DateTime  @default(now())
  is_active       Boolean   @default(true)

  student         Student   @relation(fields: [student_id], references: [id], onDelete: Cascade)
  subject         Subject   @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  faculty         Faculty   @relation(fields: [faculty_id], references: [id])

  @@unique([student_id, subject_id])
  @@index([student_id])
  @@index([subject_id])
  @@index([faculty_id])
  @@map("enrollments")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password_hash   String
  role            Role      @default(STUDENT)
  institution_id  String?
  pin_number      String?
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  institution     Institution? @relation(fields: [institution_id], references: [id])
  profile         Profile?      @relation("UserProfile")
  student         Student?      @relation("UserStudent")
  faculty         Faculty?      @relation("UserFaculty")
  complaints      Complaint[]   @relation("UserComplaints")
  notices         Notice[]      @relation("UserNotices")
  notifications   Notification[] @relation("UserNotifications")
  audit_logs      AuditLog[]    @relation("UserAuditLogs")
  sessions        Session[]     @relation("UserSessions")

  @@index([email])
  @@index([role])
  @@index([institution_id])
  @@index([pin_number])
  @@map("users")
}

model Profile {
  id            String  @id @default(cuid())
  user_id       String  @unique
  full_name     String
  pin_number    String?
  avatar_url    String?
  phone         String?
  department    String?
  bio           String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user          User    @relation("UserProfile", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([pin_number])
  @@map("profiles")
}

model Assignment {
  id            String    @id @default(cuid())
  title         String
  description   String?
  instructions  String?
  due_date      DateTime
  max_grade     Float     @default(100)
  subject_id    String
  faculty_id    String
  is_active     Boolean   @default(true)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  subject       Subject   @relation(fields: [subject_id], references: [id])
  submissions   Submission[]

  @@index([subject_id])
  @@index([faculty_id])
  @@index([due_date])
  @@map("assignments")
}

model Submission {
  id            String    @id @default(cuid())
  assignment_id String
  student_id    String
  file_url      String?
  content       String?
  grade         Float?
  feedback      String?
  submitted_at  DateTime  @default(now())
  graded_at     DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  assignment    Assignment @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  student       Student   @relation("StudentSubmissions", fields: [student_id], references: [id])

  @@unique([assignment_id, student_id])
  @@index([assignment_id])
  @@index([student_id])
  @@map("submissions")
}

model Attendance {
  id            String           @id @default(cuid())
  student_id    String
  subject_id    String
  date          DateTime         @db.Date
  status        AttendanceStatus
  marked_by     String
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  student       Student          @relation("StudentAttendances", fields: [student_id], references: [id])
  subject       Subject          @relation(fields: [subject_id], references: [id])

  @@unique([student_id, date, subject_id])
  @@index([student_id])
  @@index([subject_id])
  @@index([date])
  @@map("attendance")
}

model Notice {
  id            String    @id @default(cuid())
  title         String
  content       String
  priority      String    @default("normal")
  category      String    @default("general")
  published_by  String
  is_active     Boolean   @default(true)
  published_at  DateTime  @default(now())
  expires_at    DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  publisher     User      @relation("UserNotices", fields: [published_by], references: [id])

  @@index([published_at])
  @@index([category])
  @@index([priority])
  @@map("notices")
}

model Complaint {
  id            String          @id @default(cuid())
  student_id    String
  title         String
  description   String
  category      String          @default("general")
  status        ComplaintStatus @default(PENDING)
  priority      String          @default("normal")
  assigned_to   String?
  resolution    String?
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt
  resolved_at   DateTime?

  student       User            @relation("UserComplaints", fields: [student_id], references: [id])

  @@index([student_id])
  @@index([status])
  @@index([category])
  @@map("complaints")
}

model FeeStructure {
  id              String    @id @default(cuid())
  name            String
  amount          Float
  category        String
  academic_year   String
  course_type     CourseType
  branch_id       String?
  due_date        DateTime
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  institution     Institution @relation(fields: [institution_id], references: [id])
  institution_id  String
  payments        FeePayment[]

  @@index([institution_id])
  @@index([academic_year])
  @@index([course_type])
  @@index([branch_id])
  @@map("fee_structures")
}

model FeePayment {
  id              String    @id @default(cuid())
  student_id      String
  fee_id          String
  amount          Float
  payment_method  String?
  transaction_id  String?
  status          FeeStatus @default(PENDING)
  paid_at         DateTime?
  due_date        DateTime
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  student         Student   @relation(fields: [student_id], references: [id])
  fee_structure   FeeStructure @relation(fields: [fee_id], references: [id])

  @@index([student_id])
  @@index([fee_id])
  @@index([status])
  @@map("fee_payments")
}

model Notification {
  id              String            @id @default(cuid())
  title           String
  message         String
  type            NotificationType
  institution_id  String?
  is_read         Boolean           @default(false)
  created_at      DateTime          @default(now())

  institution     Institution?       @relation(fields: [institution_id], references: [id])
  user            User?             @relation("UserNotifications", fields: [user_id], references: [id])
  user_id         String?

  @@index([institution_id])
  @@index([user_id])
  @@index([type])
  @@index([created_at])
  @@map("notifications")
}

model Permission {
  id          String    @id @default(cuid())
  code        String    @unique
  name        String
  description String?
  category    String    @default("general")
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  roles       RolePermission[]

  @@index([category])
  @@index([code])
  @@map("permissions")
}

model RolePermission {
  id            String      @id @default(cuid())
  role          Role
  permission_id String
  created_at    DateTime    @default(now())

  permission    Permission  @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@unique([role, permission_id])
  @@index([role])
  @@map("role_permissions")
}

model AuditLog {
  id          String    @id @default(cuid())
  user_id     String?
  action      String
  entity_type String
  entity_id   String?
  old_values  Json?
  new_values  Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime  @default(now())

  user        User?      @relation("UserAuditLogs", fields: [user_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([entity_type])
  @@index([entity_id])
  @@index([action])
  @@index([created_at])
  @@map("audit_logs")
}

model Session {
  id          String    @id @default(cuid())
  user_id     String
  token       String    @unique
  ip_address  String?
  user_agent  String?
  expires_at  DateTime
  created_at  DateTime  @default(now())

  user        User      @relation("UserSessions", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
  @@map("sessions")
}
